---
# tasks file for test-6-els
# Create snapshot for the donor instance
   # ######################################################################## #
   # Copyright 2020 Amazon Web Services, Inc.                                 #
   #                                                                          #
   # Licensed under the Apache License, Version 2.0 (the "License");          #
   # you may not use this file except in compliance with the License.         #
   # You may obtain a copy of the License at                                  #
   #                                                                          #
   #     http://www.apache.org/licenses/LICENSE-2.0                           #
   #                                                                          #
   # Unless required by applicable law or agreed to in writing, software      #
   # distributed under the License is distributed on an "AS IS" BASIS,        #
   # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. #
   # See the License for the specific language governing permissions and      #
   # limitations under the License.                                           #
   # ######################################################################## #

# This next task has been replace by "get_instance_information.yml"
# There is no reason to require login to the instance. This does.
# - name: Identify the Root volume of the rhel-6-instance
#   amazon.aws.ec2_metadata_facts:

#- name: Get the instance root volume
#  amazon.aws.ec2_vol_info:
#    aws_access_key: "{{ inject.aws_access_key | default(omit) }}"
#    aws_secret_key: "{{ inject.aws_secret_key | default(omit) }}"
#    profile: "{{ inject.profile | default(omit) }}"
#    region: "{{ inject.region | default(omit) }}"
#    filters:
#      attachment.instance-id: "{{ donor_instance_id }}"
#      attachment.device: "{{ donor_instance_root_volume_device_name }}"
#  delegate_to: 127.0.0.1
#  register: donor_instance_root_volume_info
#

- name: Show block device mappings
  debug:
    var: block_device.ebs.volume_id

- name: "Gather vol {{ block_device.ebs.volume_id }} info"
  amazon.aws.ec2_vol_info:
    filters:
      volume-id: '{{ block_device.ebs.volume_id }}'
  register: donor_volume

- name: "Create Snapshot of {{ donor_instance.instance_id }} vol: {{ block_device.ebs.volume_id }}" 
  amazon.aws.ec2_snapshot:
    aws_access_key: "{{ ansible_env.AWS_ACCESS_KEY_ID | default(omit) }}"
    aws_secret_key: "{{ ansible_env.AWS_SECRET_ACCESS_KEY | default(omit) }}"
    #profile: "{{ inject.profile | default(omit) }}"
    region: "{{ ansible_env.AWS_DEFAULT_REGION | default(omit) }}"
    volume_id: '{{ block_device.ebs.volume_id }}'
    last_snapshot_min_age: 120
    description: "Snapshot of {{ block_device.ebs.volume_id }} destined for rhel-6-els from {{ donor_instance.instance_id }}"
    #snapshot_tags: "{{ inject.tags | combine({ 'Name': donor_instance.instance_id, 'els_status': 'active', 'els_stage':'one'}) }}"
    wait: yes
    wait_timeout: 7200
  delegate_to: 127.0.0.1
  register: donor_snapshot

- name: Add snapshot to the main list
  set_fact:
    my_snaps: "{{ my_snaps + [donor_snapshot] }}"

- name: "Create volume for {{ donor_snapshot }}"
  amazon.aws.ec2_vol:
    aws_access_key: "{{ ansible_env.AWS_ACCESS_KEY_ID | default(omit) }}"
    aws_secret_key: "{{ ansible_env.AWS_SECRET_ACCESS_KEY | default(omit) }}"
    #profile: "{{ inject.profile | default(omit) }}"
    region: "{{ ansible_env.AWS_DEFAULT_REGION | default(omit) }}"
    ec2_url: "{{ ec2_url | default(omit) }}"
    snapshot: '{{ donor_snapshot.snapshot_id }}'
    volume_type: '{{ donor_volume[0].type }}'
    volume_size: '{ donor_snapshot.volume_size }}'
    zone: '{{ donor_volume[0].zone }}'
    tags: '{{ donor_snapshot.tags }}'
  delegate_to: localhost
  register: my_vol

- name: Add volume to the main list
  set_fact:
    my_snaps: "{{ my_vols + [my_vol] }}"
